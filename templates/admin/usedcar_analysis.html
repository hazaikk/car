{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
<style>
    .analysis-container {
        padding: 20px;
    }
    .filter-section {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .results-section {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
    }
    .chart-container {
        height: 400px;
        margin-bottom: 20px;
    }
    .summary-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .stat-box {
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        text-align: center;
        min-width: 150px;
        margin: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-box h4 {
        margin-top: 0;
        color: #447e9b;
        font-size: 14px;
    }
    .stat-box p {
        font-size: 20px;
        font-weight: bold;
        margin: 5px 0 0;
        color: #333;
    }
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
    }
    .loading img {
        width: 50px;
    }
</style>
{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
    <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
    &rsaquo; <a href="{% url 'admin:app_list' app_label='crawler' %}">Crawler</a>
    &rsaquo; <a href="{% url 'admin:crawler_usedcar_changelist' %}">Used cars</a>
    &rsaquo; {% trans 'Interactive Analysis' %}
</div>
{% endblock %}

{% block content %}
<div class="analysis-container">
    <h1>{{ title }}</h1>
    
    <div class="filter-section">
        <form id="analysis-form" class="row">
            <div class="col-md-4 form-group">
                <label for="analysis-type">分析类型</label>
                <select id="analysis-type" name="type" class="form-control">
                    {% for type in analysis_types %}
                    <option value="{{ type.id }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-8 form-group">
                <label>品牌筛选</label>
                <div class="d-flex flex-wrap">
                    <select id="brand-filter" name="brands" class="form-control" multiple>
                        {% for brand in brands %}
                        <option value="{{ brand.id }}">{{ brand.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="col-md-4 form-group">
                <label>地区筛选</label>
                <select id="region-filter" name="regions" class="form-control" multiple>
                    <!-- 地区选项将通过AJAX动态加载 -->
                </select>
            </div>
            
            <div class="col-md-4 form-group">
                <label>年份范围</label>
                <div class="d-flex">
                    <input type="number" id="year-from" name="year_from" class="form-control mr-2" placeholder="起始年份">
                    <input type="number" id="year-to" name="year_to" class="form-control" placeholder="结束年份">
                </div>
            </div>
            
            <div class="col-md-4 form-group">
                <label>里程范围(万公里)</label>
                <div class="d-flex">
                    <input type="number" id="mileage-from" name="mileage_from" class="form-control mr-2" placeholder="最小里程">
                    <input type="number" id="mileage-to" name="mileage_to" class="form-control" placeholder="最大里程">
                </div>
            </div>
            
            <div class="col-12 text-right">
                <button type="submit" class="btn btn-primary">分析数据</button>
            </div>
        </form>
    </div>
    
    <div class="loading">
        <img src="{% static 'admin/img/icon-loading.gif' %}" alt="Loading...">
        <p>正在分析数据，请稍候...</p>
    </div>
    
    <div class="results-section" style="display: none;">
        <div class="summary-stats">
            <div class="stat-box">
                <h4>总车辆数</h4>
                <p id="total-count">0</p>
            </div>
            <div class="stat-box">
                <h4>平均价格</h4>
                <p id="avg-price">0.00 万元</p>
            </div>
            <div class="stat-box">
                <h4>最低价格</h4>
                <p id="min-price">0.00 万元</p>
            </div>
            <div class="stat-box">
                <h4>最高价格</h4>
                <p id="max-price">0.00 万元</p>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="analysis-chart"></canvas>
        </div>
        
        <div class="table-responsive">
            <table id="data-table" class="table table-striped table-bordered">
                <thead>
                    <tr id="table-header">
                        <!-- 表头将根据分析类型动态生成 -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- 表格数据将根据分析结果动态生成 -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // 加载地区数据
        $.ajax({
            url: '{% url "admin:crawler_usedcar_analysis_data" %}',
            data: { type: 'count_by_region' },
            success: function(data) {
                var regionSelect = $('#region-filter');
                regionSelect.empty();
                
                $.each(data.labels, function(index, region) {
                    regionSelect.append($('<option></option>').val(region).text(region));
                });
            }
        });
        
        // 图表对象
        var chart = null;
        
        // 表单提交
        $('#analysis-form').on('submit', function(e) {
            e.preventDefault();
            
            // 显示加载中
            $('.loading').show();
            $('.results-section').hide();
            
            // 如果已有图表，销毁它
            if (chart) {
                chart.destroy();
            }
            
            // 获取表单数据
            var formData = $(this).serialize();
            
            // 发送AJAX请求
            $.ajax({
                url: '{% url "admin:crawler_usedcar_analysis_data" %}',
                data: formData,
                success: function(data) {
                    // 隐藏加载中，显示结果
                    $('.loading').hide();
                    $('.results-section').show();
                    
                    // 更新统计摘要
                    $('#total-count').text(data.summary.total_count);
                    $('#avg-price').text(data.summary.avg_price.toFixed(2) + ' 万元');
                    $('#min-price').text(data.summary.min_price.toFixed(2) + ' 万元');
                    $('#max-price').text(data.summary.max_price.toFixed(2) + ' 万元');
                    
                    // 渲染图表
                    renderChart(data);
                    
                    // 渲染表格
                    renderTable(data);
                },
                error: function() {
                    $('.loading').hide();
                    alert('数据分析请求失败，请重试。');
                }
            });
        });
        
        // 渲染图表
        function renderChart(data) {
            var ctx = document.getElementById('analysis-chart').getContext('2d');
            
            var chartConfig = {
                type: data.type,
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: data.title,
                        data: data.values,
                        backgroundColor: getColors(data.labels.length, 0.7),
                        borderColor: getColors(data.labels.length, 1),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: data.title,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: data.type === 'pie'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    var label = context.label || '';
                                    var value = context.raw;
                                    var count = data.counts ? data.counts[context.dataIndex] : null;
                                    
                                    if (label) {
                                        label += ': ';
                                    }
                                    
                                    if (data.type === 'pie') {
                                        label += value + ' 辆';
                                    } else if (data.title.includes('价格')) {
                                        label += value.toFixed(2) + ' 万元';
                                        if (count) {
                                            label += ' (' + count + ' 辆)';
                                        }
                                    } else {
                                        label += value;
                                    }
                                    
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            display: data.type !== 'pie',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: data.title.includes('价格') ? '价格 (万元)' : '数量',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        x: {
                            display: data.type !== 'pie',
                            title: {
                                display: true,
                                text: getXAxisTitle(data),
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            };
            
            // 如果有最小值和最大值，添加误差线
            if (data.min_values && data.max_values && data.type !== 'pie') {
                chartConfig.data.datasets[0].errorBars = {
                    y: {
                        plus: data.max_values.map((max, i) => max - data.values[i]),
                        minus: data.values.map((val, i) => val - data.min_values[i])
                    }
                };
            }
            
            chart = new Chart(ctx, chartConfig);
        }
        
        // 渲染表格
        function renderTable(data) {
            var header = $('#table-header');
            var body = $('#table-body');
            
            // 清空表格
            header.empty();
            body.empty();
            
            // 根据分析类型设置表头
            var analysisType = $('#analysis-type').val();
            var columns = [];
            
            if (analysisType === 'price_by_brand') {
                columns = ['品牌', '平均价格(万元)', '车辆数量', '最低价格(万元)', '最高价格(万元)'];
            } else if (analysisType === 'price_by_region') {
                columns = ['地区', '平均价格(万元)', '车辆数量', '最低价格(万元)', '最高价格(万元)'];
            } else if (analysisType === 'price_by_year') {
                columns = ['年份', '平均价格(万元)', '车辆数量', '最低价格(万元)', '最高价格(万元)'];
            } else if (analysisType === 'price_by_mileage') {
                columns = ['里程范围(万公里)', '平均价格(万元)', '车辆数量', '最低价格(万元)', '最高价格(万元)'];
            } else if (analysisType.startsWith('count_by_')) {
                columns = [getColumnName(analysisType), '车辆数量', '占比(%)'];
            }
            
            // 添加表头
            var headerRow = '';
            columns.forEach(function(column) {
                headerRow += '<th>' + column + '</th>';
            });
            header.html(headerRow);
            
            // 添加表格数据
            var rows = '';
            var total = data.summary.total_count;
            
            for (var i = 0; i < data.labels.length; i++) {
                var row = '<tr>';
                
                if (analysisType === 'price_by_brand' || analysisType === 'price_by_region' || 
                    analysisType === 'price_by_year' || analysisType === 'price_by_mileage') {
                    row += '<td>' + data.labels[i] + '</td>';
                    row += '<td>' + data.values[i].toFixed(2) + '</td>';
                    row += '<td>' + data.counts[i] + '</td>';
                    row += '<td>' + data.min_values[i].toFixed(2) + '</td>';
                    row += '<td>' + data.max_values[i].toFixed(2) + '</td>';
                } else if (analysisType.startsWith('count_by_')) {
                    var percentage = (data.values[i] / total * 100).toFixed(2);
                    row += '<td>' + data.labels[i] + '</td>';
                    row += '<td>' + data.values[i] + '</td>';
                    row += '<td>' + percentage + '%</td>';
                }
                
                row += '</tr>';
                rows += row;
            }
            
            body.html(rows);
        }
        
        // 获取X轴标题
        function getXAxisTitle(data) {
            var analysisType = $('#analysis-type').val();
            
            if (analysisType === 'price_by_brand') {
                return '品牌';
            } else if (analysisType === 'price_by_region') {
                return '地区';
            } else if (analysisType === 'price_by_year') {
                return '年份';
            } else if (analysisType === 'price_by_mileage') {
                return '里程范围(万公里)';
            } else if (analysisType === 'count_by_brand') {
                return '品牌';
            } else if (analysisType === 'count_by_region') {
                return '地区';
            } else if (analysisType === 'count_by_fuel') {
                return '燃料类型';
            } else if (analysisType === 'count_by_transmission') {
                return '变速箱类型';
            } else if (analysisType === 'count_by_color') {
                return '车身颜色';
            }
            
            return '';
        }
        
        // 获取列名
        function getColumnName(analysisType) {
            if (analysisType === 'count_by_brand') {
                return '品牌';
            } else if (analysisType === 'count_by_region') {
                return '地区';
            } else if (analysisType === 'count_by_fuel') {
                return '燃料类型';
            } else if (analysisType === 'count_by_transmission') {
                return '变速箱类型';
            } else if (analysisType === 'count_by_color') {
                return '车身颜色';
            }
            
            return '';
        }
        
        // 生成颜色数组
        function getColors(count, alpha) {
            var colors = [];
            var hueStep = 360 / count;
            
            for (var i = 0; i < count; i++) {
                var hue = i * hueStep;
                colors.push('hsla(' + hue + ', 70%, 60%, ' + alpha + ')');
            }
            
            return colors;
        }
    });
</script>
{% endblock %}