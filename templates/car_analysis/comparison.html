{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>竞品对比</h2>
    
    <!-- 车型选择 -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">选择对比车型</h5>
            <div class="row">
                <div class="col-md-4">
                    <select class="form-select" id="car1">
                        <option selected>选择第一个车型...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="car2">
                        <option selected>选择第二个车型...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="car3">
                        <option selected>选择第三个车型...</option>
                    </select>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="btn btn-primary" id="compareBtn">开始对比</button>
            </div>
        </div>
    </div>
    
    <!-- 对比结果 -->
    <div class="row mt-4">
        <!-- 基本信息对比 -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">基本信息对比</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>对比项</th>
                                    <th>车型1</th>
                                    <th>车型2</th>
                                    <th>车型3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>厂商指导价</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>上市时间</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                                <tr>
                                    <td>销量</td>
                                    <td>-</td>
                                    <td>-</td>
                                    <td>-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 性能参数对比 -->
        <div class="col-12 mt-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">性能参数对比</h5>
                </div>
                <div class="card-body">
                    <div id="performanceChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        
        <!-- 用户评价对比 -->
        <div class="col-12 mt-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">用户评价对比</h5>
                </div>
                <div class="card-body">
                    <div id="ratingChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化图表
    const performanceChart = echarts.init(document.getElementById('performanceChart'));
    const ratingChart = echarts.init(document.getElementById('ratingChart'));
    
    // 存储选中的车型数据
    let selectedCars = [];
    let comparisonData = {};
    
    // 获取所有车型数据
    async function loadCarModels() {
        try {
            const response = await fetch('/api/car-models/');
            const data = await response.json();
            
            // 填充车型选择下拉框
            const selects = document.querySelectorAll('.car-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">请选择车型</option>';
                data.forEach(car => {
                    const option = document.createElement('option');
                    option.value = car.id;
                    option.textContent = `${car.brand_name} ${car.name}`;
                    select.appendChild(option);
                });
            });
        } catch (error) {
            console.error('加载车型数据失败:', error);
        }
    }
    
    // 获取车型对比数据
    async function getComparisonData(carIds) {
        try {
            const response = await fetch('/car_analysis/comparison/data/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ car_ids: carIds })
            });
            return await response.json();
        } catch (error) {
            console.error('获取对比数据失败:', error);
            return null;
        }
    }
    
    // 更新基本信息表格
    function updateBasicInfoTable(data) {
        const tbody = document.querySelector('#basicInfoTable tbody');
        tbody.innerHTML = '';
        
        const fields = [
            { key: 'price', label: '厂商指导价' },
            { key: 'launch_date', label: '上市时间' },
            { key: 'sales_volume', label: '月销量' },
            { key: 'fuel_type', label: '燃料类型' },
            { key: 'gearbox', label: '变速箱' },
            { key: 'engine_displacement', label: '排量' }
        ];
        
        fields.forEach(field => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${field.label}</td>
                ${data.cars.map(car => `<td>${car[field.key] || '-'}</td>`).join('')}
            `;
            tbody.appendChild(row);
        });
    }
    
    // 更新性能参数雷达图
    function updatePerformanceChart(data) {
        const option = {
            title: {
                text: '性能参数雷达图'
            },
            tooltip: {},
            legend: {
                data: data.cars.map(car => car.name)
            },
            radar: {
                indicator: [
                    { name: '动力评分', max: 5 },
                    { name: '操控评分', max: 5 },
                    { name: '舒适性评分', max: 5 },
                    { name: '油耗表现', max: 5 },
                    { name: '空间评分', max: 5 }
                ]
            },
            series: [{
                type: 'radar',
                data: data.cars.map(car => ({
                    value: [
                        car.performance?.power || 0,
                        car.performance?.handling || 0,
                        car.performance?.comfort || 0,
                        car.performance?.fuel_economy || 0,
                        car.performance?.space || 0
                    ],
                    name: car.name
                }))
            }]
        };
        
        performanceChart.setOption(option);
    }
    
    // 更新用户评价柱状图
    function updateRatingChart(data) {
        const option = {
            title: {
                text: '用户评分对比'
            },
            tooltip: {},
            legend: {
                data: data.cars.map(car => car.name)
            },
            xAxis: {
                data: ['综合评分', '外观', '内饰', '配置', '动力', '操控', '油耗', '舒适性']
            },
            yAxis: {
                type: 'value',
                max: 5
            },
            series: data.cars.map(car => ({
                name: car.name,
                type: 'bar',
                data: [
                    car.ratings?.overall || 0,
                    car.ratings?.appearance || 0,
                    car.ratings?.interior || 0,
                    car.ratings?.configuration || 0,
                    car.ratings?.power || 0,
                    car.ratings?.handling || 0,
                    car.ratings?.fuel_economy || 0,
                    car.ratings?.comfort || 0
                ]
            }))
        };
        
        ratingChart.setOption(option);
    }
    
    // 开始对比按钮点击事件
    document.getElementById('startComparison').addEventListener('click', async function() {
        const selects = document.querySelectorAll('.car-select');
        const selectedIds = Array.from(selects)
            .map(select => select.value)
            .filter(value => value);
        
        if (selectedIds.length < 2) {
            alert('请至少选择两款车型进行对比');
            return;
        }
        
        // 显示加载状态
        this.disabled = true;
        this.textContent = '加载中...';
        
        try {
            const data = await getComparisonData(selectedIds);
            if (data && data.success) {
                updateBasicInfoTable(data);
                updatePerformanceChart(data);
                updateRatingChart(data);
                
                // 显示对比结果
                document.getElementById('comparisonResults').style.display = 'block';
            } else {
                alert('获取对比数据失败，请重试');
            }
        } catch (error) {
            console.error('对比失败:', error);
            alert('对比失败，请重试');
        } finally {
            this.disabled = false;
            this.textContent = '开始对比';
        }
    });
    
    // 初始化图表配置
    const initialPerformanceOption = {
        title: { text: '性能参数雷达图' },
        tooltip: {},
        legend: { data: [] },
        radar: {
            indicator: [
                { name: '动力评分', max: 5 },
                { name: '操控评分', max: 5 },
                { name: '舒适性评分', max: 5 },
                { name: '油耗表现', max: 5 },
                { name: '空间评分', max: 5 }
            ]
        },
        series: [{ type: 'radar', data: [] }]
    };
    
    const initialRatingOption = {
        title: { text: '用户评分对比' },
        tooltip: {},
        legend: { data: [] },
        xAxis: {
            data: ['综合评分', '外观', '内饰', '配置', '动力', '操控', '油耗', '舒适性']
        },
        yAxis: { type: 'value', max: 5 },
        series: []
    };
    
    // 渲染初始图表
    performanceChart.setOption(initialPerformanceOption);
    ratingChart.setOption(initialRatingOption);
    
    // 响应窗口大小变化
    window.addEventListener('resize', function() {
        performanceChart.resize();
        ratingChart.resize();
    });
    
    // 加载车型数据
    loadCarModels();
});
</script>
{% endblock %}